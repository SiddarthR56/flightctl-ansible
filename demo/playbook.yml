- name: Test Flight Control Collection
  hosts: localhost

  tasks:
    - block:
      - name: Set default credentials
        set_fact:
          credential_defaults: &credential_defaults
            flightctl_config_file: "~/Library/Application\ Support/flightctl/client.yaml"

      - name: Get all devices
        flightctl.edge.flightctl_info:
          <<: *credential_defaults
          kind: Device

      - name: Get all fleets
        flightctl.edge.flightctl_info:
          <<: *credential_defaults
          kind: Fleet

      - name: Get information about a specific device
        flightctl.edge.flightctl_info:
          <<: *credential_defaults
          kind: Device
          name: "2bd0rgpir74c5jtrhfb1idvb2cvvvinem24t727qdudfcqr60sog"
        register: result

      - name: Get information about a specific device
        flightctl.edge.flightctl_info:
          <<: *credential_defaults
          kind: Device
          label_selector: "owner=mparra"

      - name: Create a test device in check_mode
        flightctl.edge.flightctl:
          <<: *credential_defaults
          kind: Device
          name: "test-ansible-device"
          api_version: v1alpha1
          resource_definition:
            apiVersion: v1alpha1
            kind: Device
            metadata:
              name: "test-ansible-device"
              labels:
                fleet: default
                novalue: ""
        check_mode: true

      - name: Create a test device
        flightctl.edge.flightctl:
          <<: *credential_defaults
          kind: Device
          name: "test-ansible-device"
          api_version: v1alpha1
          resource_definition:
            apiVersion: v1alpha1
            kind: Device
            metadata:
              name: "test-ansible-device"
              labels:
                fleet: default
                novalue: ""
        register: _result

      - name: Assert that Device was created
        assert:
          that:
            - _result.changed
            - _result is success

      - name: Create a test device again
        flightctl.edge.flightctl:
          <<: *credential_defaults
          kind: Device
          name: "test-ansible-device"
          api_version: v1alpha1
          resource_definition:
            apiVersion: v1alpha1
            kind: Device
            metadata:
              name: "test-ansible-device"
              labels:
                fleet: default
                novalue: ""
        register: _result

      - name: Assert that Device was not created
        assert:
          that:
            - not _result.changed
            - _result is success

      - name: Update a test device
        flightctl.edge.flightctl:
          <<: *credential_defaults
          kind: Device
          name: "test-ansible-device"
          api_version: v1alpha1
          resource_definition:
            apiVersion: v1alpha1
            kind: Device
            metadata:
              name: "test-ansible-device"
        register: _result

      - name: Assert that Device was not updated
        assert:
          that:
            - not _result.changed
            - _result is success

      - name: Create a new test device
        flightctl.edge.flightctl:
          <<: *credential_defaults
          kind: Device
          name: "test-ansible-device-2"
          api_version: v1alpha1
        register: _result

      - name: Assert that Device was created
        assert:
          that:
            - _result.changed
            - _result is success

      - name: Update new test device
        flightctl.edge.flightctl:
          <<: *credential_defaults
          kind: Device
          name: "test-ansible-device-2"
          api_version: v1alpha1
          resource_definition:
            apiVersion: v1alpha1
            kind: Device
            metadata:
              labels:
                fleet: default
                novalue: ""
        register: _result

      - name: Assert that Device was updated
        assert:
          that:
            - _result.changed
            - _result is success

      - name: Get information about a specific device
        flightctl.edge.flightctl_info:
          <<: *credential_defaults
          kind: Device
          name: "test-ansible-device"

      - name: Delete a test device in check_mode
        flightctl.edge.flightctl:
          <<: *credential_defaults
          kind: Device
          name: "test-ansible-device"
          state: absent
        check_mode: true

      - name: Delete a test device
        flightctl.edge.flightctl:
          <<: *credential_defaults
          kind: Device
          name: "test-ansible-device"
          state: absent
        register: _result

      - name: Assert that Device was deleted
        assert:
          that:
            - _result.changed
            - _result is success

      - name: Get information about a specific device
        flightctl.edge.flightctl_info:
          <<: *credential_defaults
          kind: Device
          name: "test-ansible-device"

      - name: Create a new device
        flightctl.edge.flightctl:
          <<: *credential_defaults
          kind: Device
          name: "test-ansible-device-2"
          resource_definition: "{{ lookup('file', 'device.yml') | from_yaml }}"
        register: _result

      - name: Assert that Device was created
        assert:
          that:
            - _result.changed
            - _result is success

      always:
        - name: Delete a devices
          flightctl.edge.flightctl:
            <<: *credential_defaults
            kind: Device
            name: "{{ item }}"
            state: absent
          loop:
            - "test-ansible-device"
            - "test-ansible-device-2"
            - "device-ansible-b"
          ignore_errors: true
